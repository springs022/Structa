# Structa
Version 1.0.0 (2026-01-11)

Structa は、将棋プルーフゲーム（PG）の検討を支援する CUI ツールです。  
指定した目標局面・手数のもと、いくつかの枝刈り条件を用いて、到達可能な手順を総当たり探索します。

本ツールは発展途上であり、特に処理速度に課題があります。  
手数が長めの問題の検討は非常に長時間となる恐れがあります。  
検討時間の目安は [処理時間の参考情報](#処理時間の参考情報) をご覧ください。  

以下の機能は解を取りこぼす可能性があるため慎重に利用する必要がありますが、うまく活用すれば大幅に実行時間を短縮できる場合があります。

### 開始局面設定

実戦初形以外の局面を開始局面に指定できます。  
例えば 21 手の PG において、最初の 6 手が確定していると判断できる場合、実戦初形から 6 手進めた局面を開始局面に指定し、残り 15 手の PG として検討することで、検討結果の信頼性をある程度保ちつつ、実行時間を短縮できます。

### 不動駒設定

不動駒（動くことも取られることもない駒）を指定できます。  
探索時に不動駒を動かす／取る手を除外するため、実行時間を短縮できます。


## 動作環境

Windows 10  
（Windows 11 でも動作すると思われますが未確認です）

探索型アルゴリズムのため、実行時間やメモリ使用量は問題設定に大きく依存します。


## 探索方法
基本的に Structa は、開始局面から指定手数指して得られるすべての局面を目標局面と比較することで解を探し出します。ただし 1 手指すごとに、残り手数で目標局面に到達できるかを判定し、到達不可能だと分かった場合はその局面から先は調べません（枝刈り）。  

例えば目標局面の14の地点に先手の成香がある場合、  
- 現局面ですでに14の地点に成香があれば、0手
- 上記はないが、1手で14に到達できる位置（13、16、24、25）に成香があれば、1手  
- 上記はないが、2手で到達できる位置に成香があれば、2手  
- 上記もないが、14～19に先手の香があれば 2手  
- 上記もないなら、3手（香を打って成って引く）   

という要領で、14成香の設置に掛かる最低限の手数を求めます。  
同様に目標局面のすべての先手の駒について、設置に掛かる最低限の手数を求めて総和を求め、先手が指せる残り手数を超えた場合は到達不可能と判断します。同様に後手の配置についてもチェックします。  

また、双方の持駒については、残り手数で目標局面の持駒の枚数に一致しうるかを判定します。

## ファイル構成

[ダウンロードページ](https://tsume-springs.com/tool/structa.html)で入手した ZIP ファイルを解凍し、同一フォルダ内に以下のファイルを配置してください。

- Structa.exe  
- config.txt  
- problem.txt （ファイル名は config.txt にて設定可能）  

処理実行後、同フォルダ内に結果ファイルが生成されます。

## 設定ファイル

文字コードはいずれも Shift_JIS です。  
「=」の前後に半角スペースがあってもなくても構いません。

### config.txt

```text
# 問題入力ファイル
INPUT_FILE  = problem.txt

# 検討結果出力ファイル
OUTPUT_FILE = result.txt

# 出力モード（0：SIMPLE、1：MEDIUM、2：DETAIL）
OUTPUT_LEVEL = 1

# 開始局面出力（0：出力しない、1：実戦初形ではないときは出力、2：常に出力）
ST_POS_OUTPUT_MODE = 1

# 置換表メモリ上限（MB）
TT_MEMORY_MB = 256
```

INPUT_FILE、OUTPUT_FILE ともにファイル名のみ指定できます。パスの指定はできません。  
OUTPUT_LEVEL で検討結果ファイルに出力する内容の粒度を変更できます。

- SIMPLE (0)：最低限の結果のみ
- MEDIUM (1)：上記に進捗・概要を含む
- DETAIL (2)：上記に枝刈りの統計情報を含む

ST_POS_OUTPUT_MODE で開始局面を出力するかどうかの設定ができます。  

探索の過程で「この局面からは指定局面に到達できない」と確定した場合、その局面と残り手数を記録します。  
後に同一局面が現れた際、残り手数が同じかそれ以下であれば、その先の探索を行わずに打ち切ります。  
この記録用の領域（置換表）に使用するメモリの上限を、TT_MEMORY_MB で指定します。

### problem.txt

```text
# 開始局面（無設定なら実戦初形）
START_SFEN  = 

# 指定局面
TARGET_SFEN = lnsgkgs+B1/1r7/ppppppnpp/6p2/9/2P6/PP1PPPPPP/7R1/LNSGKGSNL w LB 1

# 指定手数
MAX_DEPTH = 7

# 解数上限（1～10）
LIMIT = 3

# 何手までの手待ちを読むか（0～5）
MARGIN = 1

# 不動駒（開始局面にある動かない・取られない駒を半角数字2桁の位置で指定）
# 例 FIXED_PIECES = 13,19
FIXED_PIECES = 
```

開始局面と指定局面は SFEN で指定します。  
SFEN は、V9.41以降の柿木将棋であれば ツールバーの編集＞局面のコピー＞SFEN形式局面 で取得できます。  
[Webフェアリー将棋盤](https://tsume-springs.com/tool/fboard.html)でも SFEN をコピーできます。

START_SFEN に何も設定しなければ、実戦初形を開始局面として検討します。

LIMIT 個の解を見つけると処理を終了します。LIMIT の値は 1~10 を設定できます。

MARGIN 手までの手待ちを読みます。MARGIN の値は 0~5 を設定できます。  
0を設定した場合は手待ちする手順を一切読まなくなります。問題設定に応じて値を設定してください。

不動駒は、開始局面での位置を半角数字2桁で設定します。複数設定する場合は半角カンマで区切ります。  
下記は、後手13歩と先手19香を不動駒に設定する場合の記述です（開始局面は実戦初形）。

```text
FIXED_PIECES = 13,19
```

## 使い方

1. `config.txt` と `problem.txt` を編集する
2. `Structa.exe` を実行する（ダブルクリック等）
3. 探索状況が黒いコンソールに表示されるので、終了を待つ
4. 探索が終了すると結果が `result.txt` に出力される（追記）

実行中に **Ctrl+C** を押すと探索を中断し、終了します（再開できません）。  

## 処理時間の参考情報

本ソフトウェアを私のPCで実行した際の処理時間です。  
CPU / メモリ / OS などの実行環境により結果は大きく変わります。あくまで参考値としてご参照ください。

また、現在の Structa の特性上、目標局面の盤上に手数計算の手掛かりが残っている場合は比較的短時間で検討できます。痕跡が消えている箇所が多い場合や、作意で1つの駒が何度も動く場合、検討時間が長時間になりやすいです。

### 実行環境

- OS：Windows 10 22H2 64bit
- CPU：Intel Core i5-8250U（4コア / 8スレッド、最大 1.80 GHz）
- メモリ：8GB
- 置換表設定：TT_MEMORY_MB = 512

### 処理時間

| 番号 | 作品情報                                    | 手数 | 不動駒設定 | 検討時間 |
| -- | -------------------------------------------- | ---: | --------: | ------: |
| 1   | 高坂研／Problem Paradise／2017年4月／ツイン a） | 9  | なし | 33秒 |
| 2   | 高坂研／Problem Paradise／2017年4月／ツイン b） | 9  | なし | 27秒 |
| 3   | Proof Tachioka／Problem Paradise／2020年7月    | 10 | なし | 1分17秒 |
| 4   | 竹野龍騎／Web Fairy Paradise／2008年8月         | 10 | なし | 51秒 |
| 5-1 | 松さか子／詰将棋パラダイス／1999年9月            | 11 | なし | 30分8秒 |
| 5-2 | 松さか子／詰将棋パラダイス／1999年9月            | 11 | 18枚 | 1分15秒 |
| 6   | 神本多聞／詰将棋パラダイス／2020年8月            | 11 | なし | 1分56秒 |
| 7   | 高坂研／Problem Paradise／2017年4月            | 12 | なし | 2秒 |
| 8   | 宮内章良／詰将棋パラダイス／2012年3月            | 12 | 18枚 | 37分25秒 |
| 9   | 藤原俊雅／詰将棋パラダイス／2020年2月            | 14 | なし | 1時間28分30秒 |
| 10  | 藤原勝博／詰将棋パラダイス／2025年8月            | 15 | なし | 26分46秒 |

#### 不動駒設定

5\. 11香、13歩、17歩、19香、21桂、23歩、27歩、29桂、31銀、39銀、41金、49金、51玉、59玉、61金、69金、71銀、79銀  
8\. 11香、13歩、17歩、19香、21桂、23歩、27歩、28飛、29桂、73歩、81桂、82飛、83歩、87歩、89桂、91香、93歩、97歩


#### SFEN一覧

1. `lnsgkgsnl/1r5b1/ppppp2pp/6p2/5p3/2PP5/PP2PPPPP/1B5R1/LNSGKGSNL w - 1`
2. `lnsgkgsnl/1r5b1/ppppp2pp/6p2/3P1p3/2P6/PP2PPPPP/1B5R1/LNSGKGSNL w - 1`
3. `lnsgkgsnl/1r7/pppp+Bp1pp/6p2/9/9/PP1P+bPPPP/7R1/LN1GKGSNL b P2ps 1`
4. `ln1gkgsnl/7b1/pppp2ppp/4p2r1/7S1/2P4B1/PP1PPPPPP/7R1/LNSGKGSNL b P 1`
5. `lnsgkgsnl/1r5b1/Ppppppppp/9/9/9/pPPPPPPPP/1B5R1/LNSGKGSNL w - 1`
6. `lnggk+Bsnl/1r1sB4/pppppp1pp/6p2/9/2P6/PP1PPPPPP/7R1/LNSGKGSNL w - 1`
7. `lnsg1gsnl/1r5k1/pppppp+bpp/6p2/9/2P6/PP1PPPPPP/1S5R1/LNGKBGSNL b - 1`
8. `lnsgkg1nl/1r3s3/ppppppbpp/9/9/9/PP1PPPPPP/3SG2R1/1N2KGSNL b Pplb 1`
9. `lns2gs+Bl/1kg5r/p1pppp1pp/6p2/9/2P6/PP1PPPPPP/7R1/LNSGKGSNL b PBn 1`
10. `lnsg1gsnl/5k1b1/pppppp1pp/7+r1/8B/2P5K/PP1PPP1PP/7R1/LNSG1GSNL w 2p 1`


## 高度な使い方

Structa はコマンドライン引数を指定して実行することができます。

| オプション                      | 意味                                              |
| -------------------------- | ----------------------------------------------- |
| `-i FILE`, `--input FILE`  | 入力ファイル名を指定（省略時は config.txt の `INPUT_FILE` を使用）  |
| `-o FILE`, `--output FILE` | 出力ファイル名を指定（省略時は config.txt の `OUTPUT_FILE` を使用） |
| `--nowait`                 | 終了時に Enter キー入力を待たない                            |

### 例

```text
Structa.exe -i problem1.txt
```
入力ファイル：problem1.txt  
出力ファイル：config.txt の OUTPUT_FILE  
終了時の動作：Enter キーの入力を待つ

```text
Structa.exe -i problem1.txt -o result1.txt -nowait
```
入力ファイル：problem1.txt  
出力ファイル：result1.txt  
終了時の動作：Enter キーの入力を待たずに終了する

## 今後の開発予定

- 中断・再開機能
- 手数計算の精密化（どの駒がどの配置を実現するかの考慮）
- 目標局面からの逆算手順が限られている場合の双方向探索


## ライセンス・著作権

© 2026 Masataka Izumi  
本ソフトウェアは、将棋プルーフゲームの検討を支援する目的で個人により制作されたツールです。

**ライセンス：** GNU General Public License v3.0 (GPLv3)

Structa は、GNU General Public License v3.0 (GPLv3) のもとで公開されています。  
実行ファイル（Structa.exe）を含め、本ソフトウェアの再配布・改変・改変版の再配布は、  
GPLv3 の条件に従う必要があります。

詳細は同梱の LICENSE ファイル、または GNU GPL v3 の原文をご確認ください。

### 免責事項

本ソフトウェアは「現状のまま（AS IS）」提供されており、  
動作の正確性、完全性、有用性について、作者はいかなる保証も行いません。

本ソフトウェアの利用によって生じたいかなる損害についても、  
作者は責任を負いません。利用は自己責任でお願いします。

### 使用ライブラリ

Structa は、以下のオープンソースライブラリを使用しています。

- cshogi（GPLv3）
- NumPy（BSD License）
- psutil（BSD License）

cshogi が GPLv3 で提供されているため、本ソフトウェア全体も GPLv3 として公開されています。

### 実行ファイル

本ソフトウェアの実行ファイル（Structa.exe）は、PyInstaller を用いて生成されています。

### アイコン

本ソフトウェアで使用しているアイコンは、以下を利用しています。

[tesseract](https://icons8.com/icon/0DSGyJGttgXG/tesseract) icon  by [Icons8](https://icons8.com)

## 謝辞

高坂研さんより、将棋プルーフゲーム全作リストをご提供いただきました。Structa のテストに主に利用させていただきました。心より感謝申し上げます。  

藤原俊雅さんには、本ツールを先行してご利用いただき使用感についてフィードバックいただきました。また、Structa の性能向上に役立つ手数計算のアイデアを多数ご教示いただきました。心より感謝申し上げます。
